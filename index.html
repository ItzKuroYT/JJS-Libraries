<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JJS Library — Search & Copy</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7c3aed;--glass:rgba(255,255,255,0.03)}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071024 0%,#081226 100%);color:#e6eef6}
    .container{max-width:980px;margin:36px auto;padding:28px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);border-radius:12px;box-shadow:0 6px 30px rgba(2,6,23,0.8)}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between}
    h1{font-size:20px;margin:0}
    .credits{font-size:13px;color:var(--muted)}
    .controls{display:flex;gap:12px;align-items:center;margin-top:14px}
    input.search{flex:1;padding:10px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:var(--glass);color:inherit}
    .list{margin-top:18px;display:grid;gap:12px}
    .card{background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    .card h3{margin:0;font-size:16px}
    .meta{font-size:13px;color:var(--muted);margin-top:6px;display:flex;gap:8px;align-items:center}
    .actions{margin-top:10px;display:flex;gap:8px}
    button{background:linear-gradient(180deg,var(--accent),#5b21b6);border:none;color:white;padding:8px 10px;border-radius:8px;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    pre.code{background:#020617;color:#dff0ff;padding:12px;border-radius:8px;overflow:auto;max-height:260px;margin:10px 0}
    .small{font-size:13px}
    .link{color:var(--accent);text-decoration:none}
    @media(max-width:600px){.container{margin:18px;padding:16px}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>JJS Library — Search & Copy</h1>
        <div class="credits">Original credits shown in each library. Use code sections to view or copy.</div>
      </div>
      <div class="small">Made for Jujutsu Shenanigans</div>
    </header>

    <div class="controls">
        <input id="search" class="search" placeholder="Search libraries (title, tags)..." />
        <div style="display:flex;gap:8px;align-items:center">
          <div id="authBox" style="display:flex;gap:8px;align-items:center">
            <input id="authUser" placeholder="username" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04)" />
            <input id="authPass" type="password" placeholder="password" style="padding:8px;border-radius:6px;border:1px solid rgba(255,255,255,0.04)" />
            <button id="signupBtn" class="ghost">Sign up</button>
            <button id="loginBtn" class="ghost">Log in</button>
            <div id="userLabel" class="small" style="margin-left:8px"></div>
          </div>
          <button id="createEntry" class="ghost">Create</button>
          <button id="newEntry" class="ghost">Discord</button>
        </div>
    </div>

    <div id="list" class="list"></div>
  </div>

  <template id="cardTpl">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 class="title"></h3>
          <div class="meta"><span class="author"></span><span class="sep">•</span><a class="orig link" target="_blank">Original credit</a></div>
        </div>
        <div class="small">tag: <span class="tags"></span></div>
      </div>
      <div class="actions">
        <button class="toggle">Show code</button>
        <button class="copy">Copy</button>
        <button class="ghost viewOrig">Open credit</button>
      </div>
      <div class="codeWrap" style="display:none">
        <pre class="code" data-full=""></pre>
      </div>
    </div>
  </template>


  <script>
    // Sample libraries array — you can extend this or load from a JSON endpoint
    const libs = [
      {
        id: 'hollow-purple',
        title: 'Create a post to share your library with the community! Include details like title, description, tags, and code. You can also link to an original credit if your library is inspired by or based on someone else\'s work.',
        author: 'Kuro',
        credit: 'https://www.youtube.com/@FFS-Productions',
        tags: ['help','guide','how-to'],
        // Put the long import code here (string). Keep it escaped as needed.
        code: `
Get a code from the character builder in jjs, then paste it here. When you click "Copy", the full code will be copied to your clipboard for easy sharing or use in your own builds.
`
      }
    ];

    const listEl = document.getElementById('list');
    const tpl = document.getElementById('cardTpl');
    const search = document.getElementById('search');

    function render(filtered){
        listEl.innerHTML = '';
      if(filtered.length===0){
        listEl.innerHTML = '<div class="small">No libraries match your search.</div>';
        return;
      }
      filtered.forEach(lib=>{
        const node = tpl.content.cloneNode(true);
        node.querySelector('.title').textContent = lib.title;
        node.querySelector('.author').textContent = lib.author;
        node.querySelector('.orig').href = lib.credit;
        node.querySelector('.orig').textContent = 'Credit';
        node.querySelector('.tags').textContent = lib.tags.join(', ');
        const pre = node.querySelector('.code');
        pre.textContent = lib.code;
        pre.setAttribute('data-full', lib.code);

        const card = node.querySelector('.card');
        const toggle = node.querySelector('.toggle');
        const copyBtn = node.querySelector('.copy');
        const viewOrig = node.querySelector('.viewOrig');
        const wrap = node.querySelector('.codeWrap');

        toggle.addEventListener('click', ()=>{
          if(wrap.style.display==='none'){
            wrap.style.display='block'; toggle.textContent='Hide code';
          } else { wrap.style.display='none'; toggle.textContent='Show code'; }
        });

        copyBtn.addEventListener('click', async ()=>{
          try{
            await navigator.clipboard.writeText(pre.getAttribute('data-full'));
            copyBtn.textContent='Copied!';
            setTimeout(()=>copyBtn.textContent='Copy',1400);
          }catch(e){
            alert('Copy failed — select and copy manually.');
          }
        });

        viewOrig.addEventListener('click', ()=>window.open(lib.credit,'_blank'));

        listEl.appendChild(node);
          listEl.appendChild(node);
        });
        // diagnostics removed
    }

    function filter(q){
      q = q.trim().toLowerCase();
      if(!q) return libs.slice();
      return libs.filter(l=>{
        return l.title.toLowerCase().includes(q) || (l.tags||[]).some(t=>t.includes(q)) || l.author.toLowerCase().includes(q);
      });
    }

    search.addEventListener('input', ()=>{
      render(filter(search.value));
    });

    // Add button opens Discord invite (manual additions are done by editing the file)
    document.getElementById('newEntry').addEventListener('click', ()=>{
      window.open('https://discord.gg/VqwDPu6K', '_blank');
    });

    /*
      GitHub auto-save configuration (client-side fallback)
      WARNING: Do NOT place a PAT here in production. Use the serverless endpoint below instead.
    */
    const GITHUB = {
      owner: '', // e.g. 'your-username'
      repo: '',  // e.g. 'JJS-Library'
      path: 'libs', // path inside repo to save files
      branch: 'main',
      token: '' // insecure: only for quick testing
    };

    // Serverless endpoint (preferred). If deployed on Vercel you can use
    // https://<your-project>.vercel.app/api/save-lib. Defaulting to your known deploy URL.
    const SERVERLESS_URL = 'https://jjs-libraries.vercel.app/api/save-lib';

    // Users endpoint derived from serverless base
    const USERS_URL = SERVERLESS_URL.replace(/\/save-lib$/,'/users');

    // --- Authentication helpers (client-side) ---
    function setToken(tok){ try{ localStorage.setItem('jjs_token', tok); updateUserLabel(); }catch(e){} }
    function getToken(){ try{ return localStorage.getItem('jjs_token'); }catch(e){return null;} }
    function decodeToken(tok){ if(!tok) return null; try{ const parts = tok.split('.'); if(parts.length<2) return null; const payload = parts[1]; const json = JSON.parse(atob(payload.replace(/-/g,'+').replace(/_/g,'/'))); return json; }catch(e){return null;} }
    function getCurrentUser(){ const tok = getToken(); const p = decodeToken(tok); return p ? { username: p.username, id: p.id } : null; }
    function updateUserLabel(){ const lbl = document.getElementById('userLabel'); const u = getCurrentUser(); if(u) lbl.textContent = `Signed in: ${u.username}`; else lbl.textContent = ''; }

    async function authSignup(username,password){
      try{
        const resp = await fetch(USERS_URL + '?action=signup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
        const j = await resp.json().catch(()=>null);
        if(!resp.ok) throw new Error(JSON.stringify(j));
        if(j && j.token) setToken(j.token);
        updateUserLabel();
        return j;
      }catch(err){ return null; }
    }

    async function authLogin(username,password){
      try{
        const resp = await fetch(USERS_URL + '?action=login', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ username, password }) });
        const j = await resp.json().catch(()=>null);
        if(!resp.ok) throw new Error(JSON.stringify(j));
        if(j && j.token) setToken(j.token);
        updateUserLabel();
        return j;
      }catch(err){ return null; }
    }

    // attach auth button handlers
    document.getElementById('signupBtn').addEventListener('click', ()=>{
      const u = document.getElementById('authUser').value.trim();
      const p = document.getElementById('authPass').value;
      if(!u||!p) return alert('username and password required');
      authSignup(u,p);
    });
    document.getElementById('loginBtn').addEventListener('click', ()=>{
      const u = document.getElementById('authUser').value.trim();
      const p = document.getElementById('authPass').value;
      if(!u||!p) return alert('username and password required');
      authLogin(u,p);
    });
    updateUserLabel();

    // Create entry: will attempt to save to GitHub repo when GITHUB.token is set.
    document.getElementById('createEntry').addEventListener('click', async ()=>{
      const title = prompt('Title for library:','New Library');
      if(!title) return;
      const credit = prompt('Credit / original link (optional):','');
      const code = prompt('Paste code (for long code consider editing file directly):','-- code');
      const currentUser = getCurrentUser();
      const author = currentUser ? currentUser.username : 'Anonymous';
      const lib = {id:Date.now().toString(),title,author,credit,code,tags:[]};
      libs.push(lib);
      render(filter(search.value));

      const filename = `${lib.id}-${sanitizeFilename(lib.title)}.json`;

      // Try serverless endpoint first (recommended)
      if(SERVERLESS_URL){
        try{
          const resp = await fetch(SERVERLESS_URL, { method: 'POST', headers: { 'Content-Type':'application/json' }, body: JSON.stringify({ lib, filename }) });
          const j = await resp.json().catch(()=>null);
          if(!resp.ok) throw new Error(JSON.stringify(j));
          return;
        }catch(_err){
          // serverless save failed; fall through silently
        }
      }

      // If serverless not configured, try client-side GitHub commit (NOT RECOMMENDED)
      if(GITHUB.token && GITHUB.owner && GITHUB.repo){
        try{
          await saveToGitHub(lib, filename);
          alert('Saved to repository path: ' + (GITHUB.path?GITHUB.path + '/':'') + filename);
        }catch(_err){
          // fallback to local download
          downloadJSON(lib, filename);
        }
      } else {
        // No GitHub config — download file locally so user can upload or commit manually
        downloadJSON(lib, filename);
        alert('No serverless URL or GitHub config set — downloaded JSON locally for manual upload.');
      }
    });

    // Helper: download an object as JSON file (local fallback)
    function downloadJSON(obj, filename){
      const blob = new Blob([JSON.stringify(obj, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename || 'data.json';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    }

    function sanitizeFilename(name){
      return name.replace(/[^a-z0-9-_. ]/gi,'_').slice(0,60);
    }

    // Save a library file into the configured GitHub repo (creates or updates file)
    async function saveToGitHub(obj, filename){
      const basePath = GITHUB.path ? GITHUB.path.replace(/^\/+|\/+$/g,'') + '/' : '';
      const path = `${basePath}${filename}`;
      const apiBase = `https://api.github.com/repos/${GITHUB.owner}/${GITHUB.repo}/contents/${encodeURIComponent(path)}`;
      const headers = { 'Accept': 'application/vnd.github.v3+json', 'Authorization': `token ${GITHUB.token}` };

      // check if file exists to obtain sha
      let sha = null;
      const getResp = await fetch(apiBase + `?ref=${encodeURIComponent(GITHUB.branch)}`, { headers });
      if(getResp.status === 200){
        const data = await getResp.json(); sha = data.sha;
      }

      const content = toBase64(JSON.stringify(obj, null, 2));
      const body = { message: `Add/Update library ${obj.title}`, content, branch: GITHUB.branch };
      if(sha) body.sha = sha;

      const putResp = await fetch(apiBase, { method: 'PUT', headers: Object.assign({'Content-Type':'application/json'}, headers), body: JSON.stringify(body) });
      if(!putResp.ok) throw new Error('GitHub API error: ' + putResp.status + ' ' + await putResp.text());
      return await putResp.json();
    }

    // Basic unicode-safe base64
    function toBase64(str){
      try{ return btoa(unescape(encodeURIComponent(str))); }catch(e){
        // fallback using TextEncoder
        const bytes = new TextEncoder().encode(str);
        let binary = '';
        bytes.forEach(b=>binary += String.fromCharCode(b));
        return btoa(binary);
      }
    }

    // Load remote libraries (if any) then render
    async function loadRemoteLibs(){
      const diagnostics = document.getElementById('diagnostics');
      if(diagnostics) diagnostics.textContent = 'Loading remote libraries...';
      const owner = (typeof GITHUB !== 'undefined' && GITHUB.owner) ? GITHUB.owner : 'ItzKuroYT';
      const repo = (typeof GITHUB !== 'undefined' && GITHUB.repo) ? GITHUB.repo : 'JJS-Libraries';
      const path = (typeof GITHUB !== 'undefined' && GITHUB.path) ? GITHUB.path : 'libs';
      const api = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      try{
        const listResp = await fetch(api);
        if(!listResp.ok){
          if(diagnostics) diagnostics.textContent = `Failed to list remote libs: ${listResp.status} ${await listResp.text()}`;
          render(libs);
          return;
        }
        const list = await listResp.json();
        if(!Array.isArray(list)){ if(diagnostics) diagnostics.textContent = 'No remote files found.'; render(libs); return; }
        let added = 0;
        for(const item of list){
          if(item.type==='file' && item.name.endsWith('.json')){
            try{
              const j = await fetch(item.download_url).then(r=>r.json());
              if(j && j.id && !libs.some(l=>l.id===j.id)) { libs.push(j); added++; }
            }catch(e){ /* ignore load error */ }
          }
        }
        if(diagnostics) diagnostics.textContent = `Loaded ${added} remote libraries from ${owner}/${repo}/${path}.`;
        render(filter(search.value));
      }catch(err){
        if(diagnostics) diagnostics.textContent = 'Error loading remote libs: ' + String(err);
        render(libs);
      }
    }

    render(libs);
    loadRemoteLibs();
  </script>
</body>
</html>

